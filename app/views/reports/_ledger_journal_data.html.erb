  <% 
    account_id = params[:last_account_id].nil? ? 0 : params[:last_account_id].to_i
    period_id = params[:last_period_id].nil? ? 0 : params[:last_period_id].to_i
    balance = 0
  %>
  <% @journal_operations.each do |jo| %>
    <% if account_id != jo.account_id 
          account_id = jo.account_id
          period_id = 0 %>
      <tr class="section1">
        <td colspan="5">
          <%= jo.account.to_s %>
        </td>
      </tr>
    <% end %>
    <% if period_id != jo.journal.period_id 
          period_id = jo.journal.period_id 
          balance = previous_balance jo.account, jo.journal.period %>
      <tr class="section2">
        <td>
          <%= jo.journal.period.to_s %>
        </td>
        <td>
          <%= t(:journal_number, :scope=>:reports) %>
        </td>
        <td>
          <%= t(:credit, :scope=>:reports) %>
        </td>
        <td>
          <%= t(:debit, :scope=>:reports) %>
        </td>
        <td>
          <%= balance  %>
        </td>
      </tr>
    <% end %>
    <tr>
      <td>
        <%= jo.journal.journal_date.to_s %>
      </td>
      <td>
        <%# Some journal.numbers are empty. Should validate these numbers are not empty? %>
        <%= link_to jo.journal.number.nil? ? jo.journal.id : jo.journal.number, edit_journal_path(jo.journal.id) %>
      </td>
      <td>
        <%= jo.amount if jo.amount >= 0 %>
      </td>
      <td>
        <%= jo.amount if jo.amount < 0 %>
      </td>
      <td>
        <% balance += jo.amount %>
        <%= balance %>
      </td>
    </tr>
  <% end %>
  <script>
    <% if @journal_operations.size < 500  %>
      jQuery('#load_info').hide();
    <% else %>
      <% params[:offset] = params[:offset].to_i + 500
         params[:last_account_id] = account_id
         params[:last_period_id] = period_id
         _params = ""
         params.each_pair {|key, value| _params+="#{_params.blank? ? '' : '&'}#{key}=#{value}" }
      %>
      jQuery('#loaded_records').html( parseInt(jQuery('#loaded_records').text()) + <%= @journal_operations.size %> );
      <%= 'ajaxRequest = ' + remote_function(:url=>ledger_journal_reports_path, :method=>:get,
        :with=>"'#{_params}'") %>;
    <% end %>
  </script>
