
<% 
  account_id = params[:last_account_id].nil? ? 0 : params[:last_account_id].to_i
  period_id = params[:last_period_id].nil? ? 0 : params[:last_period_id].to_i
  balance = params[:balance].nil? ? 0 : params[:balance].to_f
  last_balance = params[:last_balance].nil? ? 0 : params[:last_balance].to_f
  diff_balance = params[:diff_balance].nil? ? 0 : params[:diff_balance].to_f
%>
<% @journal_operations.each do |jo| %>
  <% if account_id != jo.account_id 
        account_id = jo.account_id
        period_id = 0 
        from_year = @from_period.nil? ? 1900 : @from_period.year
        from_nr = @from_period.nil? ? 0 : @from_period.nr
        to_year = @to_period.nil? ? 3999 : @to_period.year
        to_nr = @to_period.nil? ? 1999 : @to_period.nr
        balance = balance_less_to_period jo.account, from_year, from_nr
        last_balance = balance_less_or_equals_to_period jo.account, to_year, to_nr
        diff_balance = last_balance - balance %>
    <tr class="section1">
      <td colspan="6">
        <%= jo.account.to_s %>
      </td>
    </tr>
  <% end %>
  <% if period_id != jo.journal.period_id 
        period_id = jo.journal.period_id  %>
    <tr class="section2">
      <td>
        <%= jo.journal.period.to_s %>
      </td>
      <td>
        <%= t(:journal_number, :scope=>:reports) %>
      </td>
      <td style="text-align: right">
        <%= t(:credit, :scope=>:reports) %>
      </td>
      <td style="text-align: right">
        <%= t(:debit, :scope=>:reports) %>
      </td>
      <td class="balance" style="text-align: right">
        <%= number_with_precision(balance, :locale =>I18n.locale) %>
      </td>
      <td>
      </td>
    </tr>
  <% end %>
  <tr>
    <td>
      <%= jo.journal.journal_date.to_s %>
    </td>
    <td>
      <%# Some journal.numbers are empty. Should validate these numbers are not empty? %>
      <%= link_to jo.journal.number ? jo.journal.number : jo.journal.id, edit_journal_path(jo.journal.id) %>
    </td>
    <td style="text-align: right">
      <%= jo.amount if jo.amount >= 0 %>
    </td>
    <td style="text-align: right">
      <%= jo.amount if jo.amount < 0 %>
    </td>
    <td class="balance" style="text-align: right">
      <% balance += jo.amount %>
      <%= number_with_precision(balance, :locale =>I18n.locale) %>
    </td>
    <td class="diff" style="text-align: right">
      <%= number_with_precision(diff_balance, :locale =>I18n.locale) %>
    </td>
  </tr>
<% end %>
<script>
  <% if @journal_operations.size < 500  %>
    jQuery('#load_info').hide();
  <% else %>
    <% 
      offset = params[:offset].to_i + 500
      last_account_id = account_id
      last_period_id = period_id
       _path = "#{ledger_journal_reports_path}?offset=#{offset}".
            concat("&last_account_id=#{last_account_id}").
            concat("&last_period_id=#{last_period_id}").
            concat("&balance=#{balance}").
            concat("&last_balance=#{last_balance}").
            concat("&diff_balance=#{diff_balance}").
            concat("&from_account_number=#{params[:from_account_number]}").
            concat("&to_account_number=#{params[:to_account_number]}").
            concat("&from_period_id=#{params[:from_period_id]}").
            concat("&to_period_id=#{params[:to_period_id]}").
            concat("&result_from_period_id=#{params[:result_from_period_id]}").
            concat("&from_year=#{params[:from_year]}").
            concat("&to_year=#{params[:to_year]}").
            concat("&from_nr=#{params[:from_nr]}").
            concat("&to_nr=#{params[:to_nr]}")
    %>
    jQuery('#loaded_records').html( parseInt(jQuery('#loaded_records').text()) + <%= @journal_operations.size %> );
    <%= 'ajaxRequest = ' + remote_function(
      :url=>_path, 
      :method=>:get) %>;
  <% end %>
</script>
